# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  tag: '$(Build.BuildId)'
  TEST_RESULTS_DIR: 'TestResults'
  REPORT_FILE: 'report.html'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'
    addToPath: true

- task: Bash@3
  displayName: 'Install Docker and Docker Compose'
  inputs:
    targetType: 'inline'
    script: |
      docker compose down --volumes --remove-orphans || true
      docker compose build
      docker compose run --rm python-playwright-tests || true

- task: Bash@3
  displayName: 'Create markdown summary'
  inputs:
    targetType: 'inline'
    workingDirectory: '$(Build.SourcesDirectory)'
    script: |
      echo "## ðŸ§ª Pytest Report" > summary.md
      echo "[ðŸ“„ View HTML Report](./TestReport/report.html)" >> summary.md
      
      if [ -f summary.md ]; then
        echo "Uploading summary.md to pipeline summary..."
        echo "##vso[task.uploadsummary]$(Build.SourcesDirectory)/summary.md"
      else
        echo "summary.md not found!"
        exit 1
      fi


- task: PublishPipelineArtifact@1
  displayName: 'Publish HTML Report Artifact'
  inputs:
    targetPath: '$(Build.SourcesDirectory)/TestResults'
    artifactName: 'TestReport'

